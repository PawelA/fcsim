#include <stdio.h>
#include <GLFW/glfw3.h>
#include "text.h"
#include "globals.h"

static unsigned char font[];
static unsigned char font_rgba[20480] = { 0 };

void text_setup_draw(void)
{
	int i;
	int j;

	for (i = 33 * 8; i < 127 * 8; i++) {
		for (j = 0; j < 5; j++) {
			if (font[i - 33 * 8] & (1 << (7 - j))) {
				font_rgba[(i * 5 + j) * 4 + 0] = 0xff;
				font_rgba[(i * 5 + j) * 4 + 1] = 0xff;
				font_rgba[(i * 5 + j) * 4 + 2] = 0xff;
				font_rgba[(i * 5 + j) * 4 + 3] = 0xaa;
			}
		}
	}

	glPixelStorei(GL_UNPACK_ALIGNMENT, 1);
	glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA, 5, 128 * 8, 0, GL_RGBA, GL_UNSIGNED_BYTE, font_rgba);
	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);
	glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);
	glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
}

static void vertex2f_pixel(int x, int y)
{
	glVertex2f((float)(2*x - the_width) / the_width,
		   (float)(the_height - 2*y) / the_height);
}

static void draw_char(char c, int x, int y, int scale)
{
	int cw = 5 * scale;
	int ch = 8 * scale;

	glEnable(GL_TEXTURE_2D);
	glEnable(GL_BLEND);
	glBegin(GL_TRIANGLE_FAN);
	glColor3f(1.0f, 1.0f, 1.0f);
	glTexCoord2f(0, (c + 0) / 128.0f); vertex2f_pixel(x, y);
	glTexCoord2f(1, (c + 0) / 128.0f); vertex2f_pixel(x + cw, y);
	glTexCoord2f(1, (c + 1) / 128.0f); vertex2f_pixel(x + cw, y + ch);
	glTexCoord2f(0, (c + 1) / 128.0f); vertex2f_pixel(x, y + ch);
	glEnd();
	glDisable(GL_TEXTURE_2D);
	glDisable(GL_BLEND);
}

void text_draw_str(const char *s, int x, int y, int scale)
{
	/*
	int tw = scale * (strlen(s) * 6 + 1);
	int th = scale * 10;
	draw_box(x - scale, y - scale, tw, th);
	*/
	for (; *s; s++) {
		draw_char(*s, x, y, scale);
		x += 6 * scale;
	}
}

void text_draw_int(int n, int x, int y, int scale)
{
	char str[20];

	sprintf(str, "%d", n);
	text_draw_str(str, x, y, scale);
}

static unsigned char font[] = {
	0x20, 0x20, 0x20, 0x20, 0x00, 0x00, 0x20, 0x00, /* ! */
	0x50, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* " */
	0x00, 0x50, 0xf8, 0x50, 0xf8, 0x50, 0x00, 0x00, /* # */
	0x20, 0x70, 0x80, 0x70, 0x08, 0x70, 0x20, 0x00, /* $ */
	0x00, 0x88, 0x10, 0x20, 0x40, 0x88, 0x00, 0x00, /* % */
	0x60, 0x90, 0xa0, 0x40, 0xa8, 0x90, 0x68, 0x00, /* & */
	0x20, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* ' */
	0x10, 0x20, 0x40, 0x40, 0x40, 0x20, 0x10, 0x00, /* ( */
	0x40, 0x20, 0x10, 0x10, 0x10, 0x20, 0x40, 0x00, /* ) */
	0x00, 0x00, 0x50, 0x20, 0x50, 0x00, 0x00, 0x00, /* * */
	0x00, 0x20, 0x20, 0xf8, 0x20, 0x20, 0x00, 0x00, /* + */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x60, /* , */
	0x00, 0x00, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, /* - */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, /* . */
	0x08, 0x10, 0x10, 0x20, 0x40, 0x40, 0x80, 0x00, /* / */
	0x70, 0x88, 0x98, 0xa8, 0xc8, 0x88, 0x70, 0x00, /* 0 */
	0x20, 0x60, 0x20, 0x20, 0x20, 0x20, 0xf8, 0x00, /* 1 */
	0x70, 0x88, 0x08, 0x10, 0x20, 0x40, 0xf8, 0x00, /* 2 */
	0x70, 0x88, 0x08, 0x30, 0x08, 0x88, 0x70, 0x00, /* 3 */
	0x10, 0x30, 0x50, 0x90, 0xf0, 0x10, 0x10, 0x00, /* 4 */
	0xf8, 0x80, 0xf0, 0x08, 0x08, 0x88, 0x70, 0x00, /* 5 */
	0x70, 0x88, 0x80, 0xf0, 0x88, 0x88, 0x70, 0x00, /* 6 */
	0xf8, 0x08, 0x10, 0x20, 0x20, 0x40, 0x40, 0x00, /* 7 */
	0x70, 0x88, 0x88, 0x70, 0x88, 0x88, 0x70, 0x00, /* 8 */
	0x70, 0x88, 0x88, 0x78, 0x08, 0x88, 0x70, 0x00, /* 9 */
	0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x20, 0x00, /* : */
	0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x20, 0x60, /* ; */
	0x00, 0x10, 0x20, 0x40, 0x20, 0x10, 0x00, 0x00, /* < */
	0x00, 0x00, 0xf8, 0x00, 0xf8, 0x00, 0x00, 0x00, /* = */
	0x00, 0x40, 0x20, 0x10, 0x20, 0x40, 0x00, 0x00, /* > */
	0x70, 0x08, 0x08, 0x10, 0x20, 0x00, 0x20, 0x00, /* ? */
	0x00, 0x00, 0x70, 0x08, 0x68, 0xa8, 0xf0, 0x00, /* @ */
	0x70, 0x88, 0x88, 0xf8, 0x88, 0x88, 0x88, 0x00, /* A */
	0xf0, 0x88, 0x88, 0xf0, 0x88, 0x88, 0xf0, 0x00, /* B */
	0x70, 0x88, 0x80, 0x80, 0x80, 0x88, 0x70, 0x00, /* C */
	0xf0, 0x88, 0x88, 0x88, 0x88, 0x88, 0xf0, 0x00, /* D */
	0xf8, 0x80, 0x80, 0xe0, 0x80, 0x80, 0xf8, 0x00, /* E */
	0xf8, 0x80, 0x80, 0xe0, 0x80, 0x80, 0x80, 0x00, /* F */
	0x70, 0x88, 0x80, 0xb8, 0x88, 0x88, 0x70, 0x00, /* G */
	0x88, 0x88, 0x88, 0xf8, 0x88, 0x88, 0x88, 0x00, /* H */
	0x70, 0x20, 0x20, 0x20, 0x20, 0x20, 0x70, 0x00, /* I */
	0x70, 0x10, 0x10, 0x10, 0x10, 0x90, 0x60, 0x00, /* J */
	0x88, 0x90, 0xa0, 0xc0, 0xa0, 0x90, 0x88, 0x00, /* K */
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xf8, 0x00, /* L */
	0x88, 0xd8, 0xa8, 0xa8, 0x88, 0x88, 0x88, 0x00, /* M */
	0x88, 0xc8, 0xc8, 0xa8, 0x98, 0x98, 0x88, 0x00, /* N */
	0x70, 0x88, 0x88, 0x88, 0x88, 0x88, 0x70, 0x00, /* O */
	0xf0, 0x88, 0x88, 0xf0, 0x80, 0x80, 0x80, 0x00, /* P */
	0x70, 0x88, 0x88, 0x88, 0xa8, 0x98, 0x78, 0x00, /* Q */
	0xf0, 0x88, 0x88, 0xf0, 0xa0, 0x90, 0x88, 0x00, /* R */
	0x70, 0x88, 0x80, 0x70, 0x08, 0x88, 0x70, 0x00, /* S */
	0xf8, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x00, /* T */
	0x88, 0x88, 0x88, 0x88, 0x88, 0x88, 0x70, 0x00, /* U */
	0x88, 0x88, 0x88, 0x50, 0x50, 0x50, 0x20, 0x00, /* V */
	0x88, 0x88, 0x88, 0xa8, 0xa8, 0xa8, 0x50, 0x00, /* W */
	0x88, 0x88, 0x50, 0x20, 0x50, 0x88, 0x88, 0x00, /* X */
	0x88, 0x88, 0x50, 0x20, 0x20, 0x20, 0x20, 0x00, /* Y */
	0xf8, 0x08, 0x10, 0x20, 0x40, 0x80, 0xf8, 0x00, /* Z */
	0x70, 0x40, 0x40, 0x40, 0x40, 0x40, 0x70, 0x00, /* [ */
	0x80, 0x40, 0x40, 0x20, 0x10, 0x10, 0x08, 0x00, /* \ */
	0x70, 0x10, 0x10, 0x10, 0x10, 0x10, 0x70, 0x00, /* ] */
	0x20, 0x50, 0x88, 0x00, 0x00, 0x00, 0x00, 0x00, /* ^ */
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x00, /* _ */
	0x40, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, /* ` */
	0x00, 0x00, 0x70, 0x08, 0x78, 0x88, 0x78, 0x00, /* a */
	0x80, 0x80, 0xf0, 0x88, 0x88, 0x88, 0xf0, 0x00, /* b */
	0x00, 0x00, 0x70, 0x88, 0x80, 0x88, 0x70, 0x00, /* c */
	0x08, 0x08, 0x78, 0x88, 0x88, 0x88, 0x78, 0x00, /* d */
	0x00, 0x00, 0x70, 0x88, 0xf0, 0x80, 0x70, 0x00, /* e */
	0x30, 0x48, 0x40, 0xe0, 0x40, 0x40, 0x40, 0x00, /* f */
	0x00, 0x00, 0x78, 0x88, 0x88, 0x78, 0x08, 0x70, /* g */
	0x80, 0x80, 0xb0, 0xc8, 0x88, 0x88, 0x88, 0x00, /* h */
	0x20, 0x00, 0x60, 0x20, 0x20, 0x20, 0x70, 0x00, /* i */
	0x10, 0x00, 0x30, 0x10, 0x10, 0x10, 0x90, 0x60, /* j */
	0x80, 0x80, 0x88, 0xb0, 0xc0, 0xa0, 0x98, 0x00, /* k */
	0x60, 0x20, 0x20, 0x20, 0x20, 0x20, 0x10, 0x00, /* l */
	0x00, 0x00, 0xd0, 0xa8, 0xa8, 0xa8, 0xa8, 0x00, /* m */
	0x00, 0x00, 0xf0, 0x88, 0x88, 0x88, 0x88, 0x00, /* n */
	0x00, 0x00, 0x70, 0x88, 0x88, 0x88, 0x70, 0x00, /* o */
	0x00, 0x00, 0xf0, 0x88, 0x88, 0xf0, 0x80, 0x80, /* p */
	0x00, 0x00, 0x78, 0x88, 0x88, 0x78, 0x08, 0x08, /* q */
	0x00, 0x00, 0xb0, 0xc8, 0x80, 0x80, 0x80, 0x00, /* r */
	0x00, 0x00, 0x70, 0x80, 0x70, 0x08, 0x70, 0x00, /* s */
	0x40, 0x40, 0xe0, 0x40, 0x40, 0x48, 0x30, 0x00, /* t */
	0x00, 0x00, 0x88, 0x88, 0x88, 0x88, 0x78, 0x00, /* u */
	0x00, 0x00, 0x88, 0x88, 0x50, 0x50, 0x20, 0x00, /* v */
	0x00, 0x00, 0x88, 0x88, 0xa8, 0xa8, 0x58, 0x00, /* w */
	0x00, 0x00, 0x88, 0x50, 0x20, 0x50, 0x88, 0x00, /* x */
	0x00, 0x00, 0x88, 0x88, 0x88, 0x78, 0x08, 0x70, /* y */
	0x00, 0x00, 0xf8, 0x10, 0x20, 0x40, 0xf8, 0x00, /* z */
	0x30, 0x40, 0x40, 0x80, 0x40, 0x40, 0x30, 0x00, /* { */
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x00, /* | */
	0x60, 0x10, 0x10, 0x08, 0x10, 0x10, 0x60, 0x00, /* } */
	0x00, 0x00, 0x00, 0x68, 0xb0, 0x00, 0x00, 0x00, /* ~ */
};
